
      const SearchPage = () => {
        const [shipments, setShipments] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [query, setQuery] = useState('');
        
        // Search State
        const [searchResults, setSearchResults] = useState([]);
        const [selectedShipment, setSelectedShipment] = useState(null);
        
        // Security & Verification States
        const [isDetailsRevealed, setIsDetailsRevealed] = useState(false);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [verifyInput, setVerifyInput] = useState('');
        const [verifyError, setVerifyError] = useState('');

        // History State
        const [historyIds, setHistoryIds] = useState([]);

        // Load Data from GAS
        useEffect(() => {
          if (typeof google !== 'undefined' && google.script) {
            google.script.run
              .withSuccessHandler((data) => {
                setShipments(data);
                setIsLoading(false);
              })
              .withFailureHandler((err) => {
                console.error("Failed to load data", err);
                setIsLoading(false);
              })
              .getData();
          } else {
            // Dev Mock
            setIsLoading(false);
          }
        }, []);

        // Load history on mount
        useEffect(() => {
          const saved = localStorage.getItem('trackmaster_search_history');
          if (saved) {
            try {
              setHistoryIds(JSON.parse(saved));
            } catch (e) {
              console.error("Failed to parse history");
            }
          }
        }, []);

        const resetSelection = () => {
          setSelectedShipment(null);
          setIsDetailsRevealed(false);
          setVerifyInput('');
          setVerifyError('');
        };

        // Search Logic
        useEffect(() => {
          const cleanQuery = query.trim();
          if (cleanQuery.length < 2) {
            setSearchResults([]);
            return;
          }

          if (selectedShipment) {
            setSelectedShipment(null);
            setIsDetailsRevealed(false);
          }

          const found = shipments
            .filter(s => 
              s.trackingNumber.toLowerCase().includes(cleanQuery.toLowerCase()) || 
              s.phoneNumber.includes(cleanQuery) ||
              s.customerName.toLowerCase().includes(cleanQuery.toLowerCase())
            )
            .sort((a, b) => b.timestamp - a.timestamp);

          setSearchResults(found);
        }, [query, shipments]);

        // Grouping Logic
        const groupedResults = useMemo(() => {
          const groups = {};
          searchResults.forEach(item => {
            const key = `${item.customerName.trim()}|${item.phoneNumber.replace(/[^0-9]/g, '')}`;
            if (!groups[key]) {
              groups[key] = {
                customerName: item.customerName,
                phoneNumber: item.phoneNumber,
                items: []
              };
            }
            groups[key].items.push(item);
          });
          return Object.values(groups);
        }, [searchResults]);

        // Derive Customer Shipments
        const customerShipments = useMemo(() => {
          if (!selectedShipment) return [];
          const clean = (p) => p.replace(/[^0-9]/g, '');
          const targetPhone = clean(selectedShipment.phoneNumber);
          const targetName = selectedShipment.customerName.trim();
          
          return shipments.filter(s => 
             clean(s.phoneNumber) === targetPhone &&
             s.customerName.trim() === targetName
          ).sort((a, b) => b.timestamp - a.timestamp);
        }, [selectedShipment, shipments]);

        const totalCOD = useMemo(() => customerShipments.reduce((sum, s) => sum + s.codAmount, 0), [customerShipments]);

        const addToHistory = (id) => {
          setHistoryIds(prev => {
            const filtered = prev.filter(existingId => existingId !== id);
            const newHistory = [id, ...filtered].slice(0, 5); 
            localStorage.setItem('trackmaster_search_history', JSON.stringify(newHistory));
            return newHistory;
          });
        };

        const removeFromHistory = (e, id) => {
          e.stopPropagation();
          setHistoryIds(prev => {
            const newHistory = prev.filter(existingId => existingId !== id);
            localStorage.setItem('trackmaster_search_history', JSON.stringify(newHistory));
            return newHistory;
          });
        };

        const clearHistory = () => {
          setHistoryIds([]);
          localStorage.removeItem('trackmaster_search_history');
        };

        const clearSearch = () => {
          setQuery('');
          setSearchResults([]);
          resetSelection();
        };

        const handleSelectShipment = (item) => {
          setSelectedShipment(item);
          setIsDetailsRevealed(false);
          setVerifyInput('');
          setVerifyError('');
          addToHistory(item.id);
        };

        const handleVerify = (e) => {
          e.preventDefault();
          if (!selectedShipment) return;
          const cleanInput = verifyInput.replace(/[^0-9]/g, '');
          const cleanTarget = selectedShipment.phoneNumber.replace(/[^0-9]/g, '').substring(0, 5);
          if (cleanInput === cleanTarget) {
            setIsDetailsRevealed(true);
            setIsModalOpen(false);
            setVerifyError('');
            setVerifyInput('');
          } else {
            setVerifyError('เลข 5 ตัวหน้าไม่ถูกต้อง กรุณาลองใหม่');
          }
        };

        const copyToClipboard = (text) => navigator.clipboard.writeText(text);

        const getTrackingUrl = (tracking, courier) => {
          if (courier && courier.includes('Kerry')) return `https://th.kerryexpress.com/th/track/?track=${tracking}`;
          if (courier && courier.includes('J&T')) return `https://www.jtexpress.co.th/service/track?billcode=${tracking}`;
          if (courier && courier.includes('Flash')) return `https://www.flashexpress.co.th/tracking/?se=${tracking}`;
          return `https://track.thailandpost.co.th/?trackNumber=${tracking}`;
        };

        const getMultiTrackingUrl = (courier, trackings) => {
            const t = trackings.join(',');
            if (courier && courier.includes('Kerry')) return `https://th.kerryexpress.com/th/track/?track=${t}`;
            if (courier && courier.includes('J&T')) return `https://www.jtexpress.co.th/service/track?billcode=${t}`;
            if (courier && courier.includes('Flash')) return `https://www.flashexpress.co.th/tracking/?se=${t}`;
            return `https://track.thailandpost.co.th/?trackNumber=${t}`;
        };

        const maskName = (fullName) => {
          if (isDetailsRevealed) return fullName;
          if (!fullName) return '';
          const parts = fullName.split(' ');
          return parts.map(part => {
              if (part.length < 2) return part;
              return part.charAt(0) + '•'.repeat(Math.max(3, part.length - 1));
          }).join(' ');
        };

        const maskPhone = (phone) => {
          if (isDetailsRevealed) return phone;
          if (!phone) return '';
          const clean = phone.replace(/[^0-9]/g, '');
          if (clean.length < 5) return clean;
          return 'xxxxx' + clean.slice(-5);
        };

        const maskTracking = (tracking) => {
          if (!tracking) return '';
          if (tracking.length < 5) return tracking;
          return '•••••' + tracking.slice(-5);
        };

        const recentShipments = historyIds
          .map(id => shipments.find(s => s.id === id))
          .filter(s => !!s);

        if (isLoading) {
          return (
             <div className="flex flex-col items-center justify-center min-h-screen">
                <div className="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                <p className="mt-4 text-slate-500 font-medium">กำลังโหลดข้อมูล...</p>
             </div>
          );
        }

        return (
          <div className="max-w-xl mx-auto flex flex-col items-center pt-6 md:pt-8 animate-fade-in px-4 pb-24 md:pb-20">
            <div className="mb-6 flex flex-col items-center text-center">
              <div className="w-14 h-14 md:w-16 md:h-16 bg-white rounded-2xl flex items-center justify-center mb-3 md:mb-4 shadow-md shadow-indigo-100 border border-slate-100">
                 <Icons.ShieldCheck className="w-7 h-7 md:w-8 md:h-8 text-indigo-600" />
              </div>
              <h1 className="text-xl md:text-2xl font-boi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          